---
title: "Chapter 5 - Visualizing the Results"
author: "Gabriel J. Odom, PhD, ThD"
date: "November 26, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




# Visualizing the Results
Given the $p$-values from these pathways, we will now graph their score (negative log of the $p$-value) and description for the top 15 most-significant pathways.

First, load the `pathwayPCA` package and the [`tidyverse` package suite](https://www.tidyverse.org/).
```{r packageLoad, message=FALSE}
library(tidyverse)
library(pathwayPCA)
```


## Trim Pathway Names
Because Wikipathways pathway collections are quite long, we truncate them for better graphical display.
```{r match_abbrev_to_name}
# Truncate names longer than 30 characters
pVals_df <- 
  ovarian_aespcOut$pVals_df %>% 
  mutate(
    description = ifelse(
      str_length(description) > 35,
      paste0(str_sub(description, 1, 33), "..."),
      description
    )
  )
```


## Clean and Wrangle the Data Results
Now we subset the top 15 pathways by unadjusted $p$-value. If we had multiple adjustment columns, then we would also have to [gather](https://rpubs.com/mm-c/gather-and-spread) the results of these columns from "wide" to "tidy" form.
```{r join_and_gather}
pValsClean_df <- 
  # Results data frame
  pVals_df %>% 
  # remove the columns we don't need
  select(-pathways, -setsize, -trim_size, -terms, -rawp) %>% 
  # take the first 15 rows
  slice(1:15) %>% 
  # add the score variable
  mutate(score = -log(FDR_BH)) %>%
  rename(
    "Pathway" = description,
    "Benjamini-Hochberg FDR" = FDR_BH
  )

pValsClean_df
```


## Plot the Tidy Results
Using this data, we can plot the top 15 pathway scores for the Benjamini-Hochberg adjustment method.
```{r bar_plots, fig.height = 6, fig.width = 10.7, out.width = "100%", out.height = "60%"}
# The modified data frame from the previous step
ggplot(pValsClean_df) +
  # set overall appearance of the plot
  theme_bw() +
  # Define the dependent and independent variables
  aes(x = reorder(Pathway, score), y = score) +
  # From the defined variables, create a vertical bar chart
  geom_bar(stat = "identity", position = "dodge", fill = "#F47321") +
  # Set main and axis titles
  ggtitle("AES-PCA Significant Wikipathways: Ovarian Cancer") +
  xlab("Pathways") +
  ylab("Negative Log BH-FDR") +
  # Add a line showing the alpha = 0.10 level
  geom_hline(yintercept = -log(0.1), size = 1, color = "#005030") +
  # Flip the x and y axes
  coord_flip()
```

</br>

*******************************************************************************

</br>

# Inspecting the Driving Proteins
Now that we have a few significant pathways, we can look at the loadings of each gene onto the first AES-PC from these pathways.
```{r significant_pathway_keys}
pVals_df %>% 
  filter(FDR_BH < 0.05) %>% 
  select(pathways)
```


## Extract Pathway Decomposition
Given the two significant pathways, we want to inspect which proteins load onto the pathway PCs. Notice that the pathway loadings are named by the internal pathway key, so we need to use the `getPathPCL()` to match this key to its pathway and extract the pathway PCs and loadings (PC & L) list from the `ovarian_aespcOut` object. Here are the PCs and loadings vectors from `path253`:
```{r path253_PCL}
path253_ls <- getPathPCLs(ovarian_aespcOut, "path253")
path253_ls
```

This tells us that `path253` represents Wikipathways pathway #3858, which is called the "Toll-like Receptor Signaling" pathway.

We can also extract the PCs and loadings vectors for `path110`, which we will compare later.
```{r path110_PCL}
path110_ls <- getPathPCLs(ovarian_aespcOut, "path110")
```


## Protein Loadings
### Wrangle Pathway Loadings
Given the loading vectors from WP3858, we need to wrangle them into a data frame that the `ggplot()` function can use. For this, we've written a function that you can modify as you need. This function takes in the pathway PC & L list returned by the `getPathPCLs()` function and returns a data frame with all the components necessary for a plot of the protein loadings.
```{r TidyLoading_fun}
TidyLoading <- function(pathwayPCL, numPCs = 1){
  
  # Remove rows with 0 loading from the first numPCs columns
  loadings_mat <- pathwayPCL$Loadings
  keepRows_idx <- rowSums(abs(loadings_mat[, 1:numPCs, drop = FALSE])) > 0
  loadings_mat <- loadings_mat[keepRows_idx, , drop = FALSE]
  
  # Sort the value on first feature
  load_df <- as.data.frame(loadings_mat)
  load_df <- load_df[
    order(load_df[, 1], decreasing = TRUE), 1:numPCs, drop = FALSE
  ]
  
  # Wrangle the sorted loadings:
  gg_df <- load_df %>% 
    # Turn the rownames into the ID column,
    rownames_to_column(var = "ID") %>% 
    # make that ID column a factor,
    mutate(ID = factor(ID, levels = ID)) %>% 
    # "tidy" the data, and
    gather(Feature, Value, -ID) %>% 
    # add the up / down indicator.
    mutate(Direction = ifelse(Value > 0, "Up", "Down"))
  
  # Add the pathway name and description
  attr(gg_df, "PathName") <- pathwayPCL$term
  attr(gg_df, "Description") <- pathwayPCL$description
  
  gg_df
  
}
```

We can use this function to "tidy up" the loadings from the "Toll-like Receptor Signaling" pathway:
```{r TidyLoadings}
tidyLoad253_df <- TidyLoading(pathwayPCL = path253_ls, numPCs = 2)
tidyLoad253_df
```

```{r TidyLoadings110, echo=FALSE}
tidyLoad110_df <- TidyLoading(pathwayPCL = path110_ls, numPCs = 2)
```


### Plot the Protein Loadings
We also wrote a function to create a `ggplot` graph object which uses this tidy data frame.
```{r PathwayBarChart_fun}
PathwayBarChart <- function(ggData_df, y_lab,
                            colours = c(Up = "#009292", Down = "#920000"),
                            label_size = 5,
                            sigFigs = 0,
                            ...){
  
  # Base plot layer
  p1 <- ggplot(ggData_df, aes(x = ID, y = Value, color = Direction))
  
  # Add geometric layer and split by Feature
  p1 <- p1 +
    geom_col(aes(fill = Direction), width = 0.5) +
    facet_wrap(~Feature, nrow = length(unique(ggData_df$Feature)))
  
  # Add Gene Labels
  p1 <- p1 +
    geom_text(
      aes(y = 0, label = ID),
      vjust = "middle",
      hjust = ifelse(ggData_df$Direction == "Up", "top", "bottom"),
      size = label_size, angle = 90, color = "black"
    )
  
  # Add Value Labels
  p1 <- p1 +
    geom_text(
      aes(label = ifelse(ggData_df$Value == 0, "", round(Value, sigFigs))),
      vjust = ifelse(ggData_df$Direction == "Up", "top", "bottom"),
      hjust = "middle",
      size = label_size, color = "black"
    )
  
  # Set the Theme
  p1 <- p1 +
    scale_y_continuous(expand = c(0.15, 0.15)) +
    theme_classic() +
    theme(
      axis.title.x = element_blank(),
      axis.text.x  = element_blank(),
      axis.ticks.x = element_blank(),
      strip.text   = element_text(size = 14),
      legend.position = "none"
    )
  
  # Titles, Subtitles, and Labels
  pathName <- attr(ggData_df, "PathName")
  pathDesc <- attr(ggData_df, "Description")
  if(is.na(pathDesc)){
    p1 <- p1 + ggtitle(pathName) + ylab(y_lab)
  } else {
    p1 <- p1 + labs(title = pathName, subtitle = pathDesc, y = y_lab)
  }
  
  # Return
  p1
  
}
```

This is the resulting loading bar plot for the "Toll-like Receptor Signaling" pathway (because all of the loadings are between -1 and 1, we set the significant figures to 2):
```{r path253_loadings_bar_chart, fig.height = 6, fig.width = 10.7, out.width = "100%", out.height = "60%"}
PathwayBarChart(
  ggData_df = tidyLoad253_df,
  y_lab = "PC Loadings",
  sigFigs = 2
)
```

For comparison, this is the bar plot for `path110`:
```{r path110_loadings_bar_chart, fig.height = 6, fig.width = 10.7, out.width = "100%", out.height = "60%"}
PathwayBarChart(
  ggData_df = tidyLoad110_df,
  y_lab = "PC Loadings",
  sigFigs = 2
)
```



## Protein Correlations with PCs
### Calculate Pathway Correlations
Additionally, we can calculate the correlation between protein expression in the assay corresponding to the "Toll-like Receptor Signaling" pathway and the PC vectors extracted from this pathway. Thus, we need to extract the recorded protein levels corresponding to the non-zero loadings for the PCs, calculate the Spearman correlations between these values and their extracted PCs, then wrangle these correlations into a data frame that the `ggplot()` function can use. We have written an additional function that you can modify as you need. This function takes in the `Omics` data container and the PC & L list returned by `getPathPCLs()`. This function returns a data frame with all the components necessary for a plot of the assay-PC correlations.
```{r TidyCorrelation_fun}
TidyCorrelation <- function(Omics, pathwayPCL, numPCs = 1){
  
  loadings_mat <- pathwayPCL$Loadings
  keepRows_idx <- rowSums(abs(loadings_mat[, 1:numPCs, drop = FALSE])) > 0
  loadings_mat <- loadings_mat[keepRows_idx, , drop = FALSE]
  
  geneNames <- rownames(loadings_mat)
  geneCorr_mat <- t(
    cor(
      pathwayPCL$PCs,
      getAssay(Omics)[geneNames],
      method = "spearman"
    )
  )

  pathwayPCL$Loadings <- geneCorr_mat
  
  TidyLoading(pathwayPCL, numPCs = numPCs)
  
}
```

We can use this function to "tidy up" the loadings from the "Toll-like Receptor Signaling" pathway:
```{r TidyCorrelation}
tidyCorr253_df <- TidyCorrelation(
  Omics = ov_OmicsSurv,
  pathwayPCL = path253_ls,
  numPCs = 2
)
tidyCorr253_df
```

### Plot the Assay-PC Correlation
This is the resulting correlation bar plot for the "Toll-like Receptor Signaling" pathway:
```{r path253_correlations_bar_chart, fig.height = 6, fig.width = 10.7, out.width = "100%", out.height = "60%"}
PathwayBarChart(
  ggData_df = tidyCorr253_df,
  y_lab = "Assay-PC Correlations",
  sigFigs = 2
)
```

## Pathway Interpretation
The intersecting genes shared by these two pathways with non-zero AES-PC loadings are [NFKB1](https://www.ncbi.nlm.nih.gov/pubmed/26345753), [MYD88](https://journals.lww.com/greenjournal/Abstract/2015/05001/Role_of_MyD88_expression_in_Epithelial_Ovarian.259.aspx), [TLR2 & TLR3](https://www.ncbi.nlm.nih.gov/pubmed/19184006), and [IKBKB & TBK1](https://www.ncbi.nlm.nih.gov/pubmed/30084832) (external literature validating the relatioship between these genes and ovarian cancer survival are linked).
